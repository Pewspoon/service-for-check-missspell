version: '3'

services:

  # Основное приложение
  app:
    # Собирать Docker-образ из Dockerfile, который находится в папке ./app
    build: ./app
    
    # Использовать файл с переменными окружения для этого контейнера
    env_file:
      # Файл .env находится в папке ./app
      - ./app/.env
    # Монтирование папок (томов) для этого контейнера
    volumes:
      # Папка ./app на хосте монтируется в папку /app внутри контейнера
      - ./app:/app

  # Nginx для обработки HTTP-запросов
  web-proxy:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      # Порт 80 на хосте → порт 80 в контейнере
      # Позволяет обращаться к веб-серверу по адресу http://localhost
      - "80:80"
    
    # Монтирование конфигурационных файлов
    volumes:
      # Файл nginx.conf из папки ./nginx на хосте монтируется как конфиг Nginx
      # :ro - только для чтения (read-only), чтобы контейнер не мог изменить файл
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    
    # Указание зависимостей между сервисами
    depends_on:
      # Этот сервис запустится только после запуска сервиса "app"
      - app

  # Сервис "rabbitmq" - брокер сообщений для асинхронной обработки задач
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    
    # Переменные окружения для настройки RabbitMQ
    environment:
      # Логин для RabbitMQ. Берется из переменной окружения RABBITMQ_USER или "admin"
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      
      # Пароль для RabbitMQ. Берется из переменной RABBITMQ_PASSWORD или "password123"
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-password123}
    
    ports:
      # Порт 5672 - для AMQP-подключений (ваше приложение подключается сюда)
      - "5672:5672"
      
      # Порт 15672 - веб-интерфейс управления (доступен по http://localhost:15672)
      - "15672:15672"
    
    # Монтирование тома для сохранения данных RabbitMQ
    volumes:
      # Папка ./rabbitmq_data на хосте монтируется в /var/lib/rabbitmq в контейнере
      # Это сохранит очереди сообщений при перезапуске контейнера
      - ./rabbitmq_data:/var/lib/rabbitmq


  database:
    image: postgres:15-alpine
    container_name: postgres_db
    
    # Переменные окружения для настройки PostgreSQL
    environment:
      # Имя базы данных. Берется из DB_NAME или "mydatabase"
      POSTGRES_DB: ${DB_NAME:-mydatabase}
      
      # Имя пользователя БД. Берется из DB_USER или "myuser"
      POSTGRES_USER: ${DB_USER:-myuser}
      
      # Пароль пользователя БД. Берется из DB_PASSWORD или "mypassword"
      POSTGRES_PASSWORD: ${DB_PASSWORD:-mypassword}
    
    # Проброс порта базы данных
    ports:
      # Порт 5432 - стандартный порт PostgreSQL
      # Позволяет подключаться к БД с хоста через localhost:5432
      - "5432:5432"
    
    # Монтирование тома для сохранения данных базы
    volumes:
      # Папка ./postgres_data на хосте монтируется в /var/lib/postgresql/data
      # Это сохранит все данные БД при перезапуске контейнера
      - ./postgres_data:/var/lib/postgresql/data